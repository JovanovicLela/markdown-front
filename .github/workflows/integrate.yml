
  on: push

  stages:
    - build
    - test

  # BUILD
  build_phase:
    stage: build
    before_script:
      - npm ci
    image: trion/ng-cli
    script:
      - ng build --prod --output-hashing=all
    cache:
      key: "$CI_COMMIT_REF_NAME"
      policy: push
      paths:
        - dist
        - node_modules
      only:
        - main

  # TEST
  test_phase:
    stage: test
    image: trion/ng-cli-karma:9.0.1
    allow_failure: false
    script:
      - ng test --progress false --watch false
    cache:
      policy: pull
      key: "$CI_COMMIT_REF_NAME"
      paths:
        - dist
        - node_modules
      only:
        main
